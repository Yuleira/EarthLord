# 交易系统数据层 - 通用设计文档

---

## 一、系统概述

### 1.1 什么是交易系统？

交易系统允许用户之间交换物品/资源/服务。本文档描述的是**异步挂单交易系统**——用户发布交易请求后无需等待，其他用户可以随时接受。

### 1.2 核心特点

| 特点 | 说明 |
|------|------|
| **异步交易** | 不需要双方同时在线 |
| **物品锁定** | 发布时立即从库存扣除，防止重复出售 |
| **自动过期** | 超时未被接受自动失效，物品退回 |
| **交易历史** | 完整记录所有交易，支持评价 |

### 1.3 适用场景

- 游戏：玩家之间交换装备、材料、道具
- 电商：二手物品交易（类似闲鱼）
- 社区：技能交换、物物交换
- 积分系统：积分兑换商品

---

## 二、核心概念

### 2.1 交易挂单（Trade Offer）

**定义**：用户发布的"我想用 A 换 B"的请求。

**类比**：就像在集市上摆摊，牌子上写着"出售苹果，收购橙子"。

```
┌─────────────────────────────────────────────┐
│              一个交易挂单包含                 │
├─────────────────────────────────────────────┤
│                                              │
│  发布者信息                                  │
│  ├─ 谁发布的（用户ID）                       │
│  └─ 发布者名称                               │
│                                              │
│  交易内容                                    │
│  ├─ 我提供什么（一个或多个物品）             │
│  └─ 我想要什么（一个或多个物品）             │
│                                              │
│  状态信息                                    │
│  ├─ 当前状态（等待中/已完成/已取消/已过期）  │
│  ├─ 发布时间                                 │
│  └─ 过期时间                                 │
│                                              │
│  完成信息（可选）                            │
│  ├─ 谁接受的                                 │
│  └─ 完成时间                                 │
│                                              │
│  附加信息（可选）                            │
│  └─ 留言备注                                 │
│                                              │
└─────────────────────────────────────────────┘
```

### 2.2 挂单状态流转

```
                    发布挂单
                       │
                       ▼
                 ┌──────────┐
                 │  active  │ ← 等待中，可被接受
                 │  等待中  │
                 └──────────┘
                       │
         ┌─────────────┼─────────────┐
         │             │             │
         ▼             ▼             ▼
    ┌────────┐   ┌────────┐   ┌────────┐
    │completed│   │cancelled│   │expired │
    │ 已完成 │   │ 已取消 │   │ 已过期 │
    └────────┘   └────────┘   └────────┘
         ↑             ↑             ↑
      被接受        主动取消      超时自动
```

**状态说明：**

| 状态 | 触发条件 | 后续操作 |
|------|---------|---------|
| active（等待中） | 发布挂单 | 可被接受、可取消 |
| completed（已完成） | 被其他用户接受 | 只读，可评价 |
| cancelled（已取消） | 发布者主动取消 | 物品退回发布者 |
| expired（已过期） | 超过有效期 | 物品退回发布者 |

### 2.3 物品锁定机制

**为什么需要锁定？**

```
┌─────────────────────────────────────────────┐
│              没有锁定会怎样？                 │
├─────────────────────────────────────────────┤
│                                              │
│  用户背包：苹果 ×5                           │
│                                              │
│  10:00  发布挂单1："出 苹果×5"               │
│  10:01  发布挂单2："出 苹果×5"  ← 还能发！   │
│  10:02  用户A 接受挂单1 → 获得苹果×5         │
│  10:03  用户B 接受挂单2 → 获得苹果×5         │
│                                              │
│  结果：5个苹果变出了10个！这是严重BUG！      │
│                                              │
└─────────────────────────────────────────────┘
```

**锁定机制的解决方案：**

```
┌─────────────────────────────────────────────┐
│              有了锁定之后                    │
├─────────────────────────────────────────────┤
│                                              │
│  用户背包：苹果 ×5                           │
│                                              │
│  10:00  发布挂单1："出 苹果×5"               │
│         → 背包扣除：苹果 5→0                 │
│         → 苹果锁定在挂单里                   │
│                                              │
│  10:01  想发布挂单2："出 苹果×5"             │
│         → 检查背包：苹果 ×0                  │
│         → 失败：物品不足！                   │
│                                              │
│  完美解决！                                  │
│                                              │
└─────────────────────────────────────────────┘
```

**物品流转图：**

```
发布时：   用户背包 ──────→ 挂单（锁定状态）

被接受时： 挂单 ──────────→ 接受者背包
           接受者背包 ────→ 发布者背包

取消时：   挂单 ──────────→ 退回发布者背包

过期时：   挂单 ──────────→ 退回发布者背包
```

---

## 三、数据模型设计

### 3.1 交易挂单表（trade_offers）

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| id | UUID | 是 | 唯一标识，自动生成 |
| owner_id | UUID | 是 | 发布者的用户ID |
| owner_username | 文本 | 否 | 发布者用户名（冗余，方便显示） |
| offering_items | JSON | 是 | 提供的物品列表 |
| requesting_items | JSON | 是 | 需要的物品列表 |
| status | 文本 | 是 | 状态：active/completed/cancelled/expired |
| message | 文本 | 否 | 可选留言 |
| created_at | 时间戳 | 是 | 创建时间 |
| expires_at | 时间戳 | 是 | 过期时间 |
| completed_at | 时间戳 | 否 | 完成时间 |
| completed_by_user_id | UUID | 否 | 接受者的用户ID |
| completed_by_username | 文本 | 否 | 接受者用户名 |

**物品列表的 JSON 格式建议：**

```
offering_items / requesting_items 格式：
[
    { "item_id": "物品标识", "quantity": 数量 },
    { "item_id": "物品标识", "quantity": 数量 },
    ...
]
```

**为什么用 JSON 存储物品？**
- 一次交易可能涉及多个物品
- 灵活支持任意物品组合
- 方便扩展（可以加品质、来源等属性）
- 不需要创建额外的关联表

### 3.2 交易历史表（trade_history）

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| id | UUID | 是 | 唯一标识 |
| offer_id | UUID | 否 | 关联的挂单ID |
| seller_id | UUID | 是 | 卖家（发布者）ID |
| seller_username | 文本 | 否 | 卖家用户名 |
| buyer_id | UUID | 是 | 买家（接受者）ID |
| buyer_username | 文本 | 否 | 买家用户名 |
| items_exchanged | JSON | 是 | 交换的物品详情 |
| completed_at | 时间戳 | 是 | 完成时间 |
| seller_rating | 整数 | 否 | 卖家给买家的评分（1-5） |
| buyer_rating | 整数 | 否 | 买家给卖家的评分（1-5） |
| seller_comment | 文本 | 否 | 卖家评语 |
| buyer_comment | 文本 | 否 | 买家评语 |

### 3.3 与现有系统的关联

交易系统需要与你项目中的以下模块关联：

```
┌─────────────────────────────────────────────┐
│              系统关联关系                    │
├─────────────────────────────────────────────┤
│                                              │
│   用户系统                                   │
│   └─ 提供 user_id、username                 │
│      （用于标识交易双方）                    │
│                                              │
│   库存/背包系统                              │
│   └─ 提供物品的增删改查                     │
│      （发布时扣除、接受时增减、取消时退回） │
│                                              │
│   物品定义系统                               │
│   └─ 提供 item_id 和物品信息                │
│      （用于显示物品名称、图标等）           │
│                                              │
└─────────────────────────────────────────────┘
```

**重要提示**：你需要根据自己项目的实际情况，确定：
- 用户表的表名和字段名
- 库存/背包表的表名和字段名
- 物品ID的字段名和类型

---

## 四、核心逻辑设计

### 4.1 创建挂单

**函数名建议**：`create_trade_offer`

**输入参数**：
- 提供的物品列表
- 需要的物品列表
- 有效期（小时数，默认24）
- 留言（可选）

**执行流程**：

```
┌─────────────────────────────────────────────┐
│              创建挂单流程                    │
├─────────────────────────────────────────────┤
│                                              │
│  1. 获取当前用户信息                         │
│     ├─ 用户ID                               │
│     └─ 用户名                               │
│                                              │
│  2. 验证提供的物品                           │
│     ├─ 遍历每个物品                         │
│     ├─ 查询用户库存中该物品的数量           │
│     ├─ 如果数量不足 → 返回失败              │
│     └─ 全部检查通过 → 继续                  │
│                                              │
│  3. 锁定物品（从库存扣除）                   │
│     ├─ 遍历每个物品                         │
│     └─ 从用户库存中减少相应数量             │
│                                              │
│  4. 计算过期时间                             │
│     └─ 过期时间 = 当前时间 + 有效期小时数   │
│                                              │
│  5. 创建挂单记录                             │
│     ├─ 状态设为 active                      │
│     ├─ 保存所有信息                         │
│     └─ 返回挂单ID                           │
│                                              │
│  6. 返回结果                                 │
│     ├─ 成功：挂单ID + 过期时间              │
│     └─ 失败：错误原因                       │
│                                              │
└─────────────────────────────────────────────┘
```

**错误处理**：

| 错误情况 | 返回信息 |
|---------|---------|
| 未登录 | "请先登录" |
| 物品不足 | "物品不足：XXX 还需 N 个" |
| 参数无效 | "请选择要交易的物品" |

### 4.2 接受交易

**函数名建议**：`accept_trade_offer`

**输入参数**：
- 挂单ID

**执行流程**：

```
┌─────────────────────────────────────────────┐
│              接受交易流程                    │
├─────────────────────────────────────────────┤
│                                              │
│  1. 获取当前用户信息                         │
│                                              │
│  2. 查询并锁定挂单（防止并发）               │
│     └─ 使用数据库行级锁                     │
│                                              │
│  3. 验证挂单状态                             │
│     ├─ 挂单存在？                           │
│     ├─ 状态是 active？                      │
│     ├─ 没有过期？                           │
│     └─ 不是自己的挂单？                     │
│     （任何一项不满足 → 返回失败）           │
│                                              │
│  4. 验证接受者库存                           │
│     ├─ 遍历挂单中"需要的物品"               │
│     ├─ 检查接受者库存是否足够               │
│     └─ 不足 → 返回失败                      │
│                                              │
│  5. 执行物品交换                             │
│     ├─ 从接受者库存扣除"需要的物品"         │
│     ├─ 向接受者库存添加"提供的物品"         │
│     └─ 向发布者库存添加"需要的物品"         │
│                                              │
│  6. 更新挂单状态                             │
│     ├─ 状态改为 completed                   │
│     ├─ 记录完成时间                         │
│     └─ 记录接受者信息                       │
│                                              │
│  7. 创建交易历史记录                         │
│                                              │
│  8. 返回结果                                 │
│     ├─ 成功：交换详情                       │
│     └─ 失败：错误原因                       │
│                                              │
└─────────────────────────────────────────────┘
```

**错误处理**：

| 错误情况 | 返回信息 |
|---------|---------|
| 挂单不存在 | "挂单不存在" |
| 挂单已失效 | "挂单已失效" |
| 挂单已过期 | "挂单已过期" |
| 接受自己的挂单 | "不能接受自己的挂单" |
| 物品不足 | "物品不足：XXX 还需 N 个" |

### 4.3 取消挂单

**函数名建议**：`cancel_trade_offer`

**输入参数**：
- 挂单ID

**执行流程**：

```
┌─────────────────────────────────────────────┐
│              取消挂单流程                    │
├─────────────────────────────────────────────┤
│                                              │
│  1. 获取当前用户信息                         │
│                                              │
│  2. 查询挂单信息                             │
│                                              │
│  3. 验证权限                                 │
│     ├─ 是自己的挂单？                       │
│     └─ 状态是 active？                      │
│     （不满足 → 返回失败）                   │
│                                              │
│  4. 退还物品                                 │
│     ├─ 遍历挂单中"提供的物品"               │
│     └─ 逐个添加回发布者库存                 │
│                                              │
│  5. 更新挂单状态                             │
│     └─ 状态改为 cancelled                   │
│                                              │
│  6. 返回成功                                 │
│                                              │
└─────────────────────────────────────────────┘
```

### 4.4 查询类函数

| 函数名 | 用途 | 返回内容 |
|--------|------|----------|
| get_my_trade_offers | 获取我发布的挂单 | 当前用户的所有挂单 |
| get_available_trade_offers | 获取可接受的挂单 | 其他用户的活跃挂单 |
| get_trade_history | 获取交易历史 | 当前用户参与的所有交易 |

### 4.5 评价交易

**函数名建议**：`rate_trade`

**输入参数**：
- 交易历史ID
- 评分（1-5）
- 评语（可选）

**执行流程**：

```
┌─────────────────────────────────────────────┐
│              评价交易流程                    │
├─────────────────────────────────────────────┤
│                                              │
│  1. 查询交易历史记录                         │
│                                              │
│  2. 验证权限                                 │
│     ├─ 当前用户是卖家或买家？               │
│     └─ 该角色还没评价过？                   │
│                                              │
│  3. 保存评价                                 │
│     ├─ 如果是卖家 → 更新 seller_rating      │
│     └─ 如果是买家 → 更新 buyer_rating       │
│                                              │
│  4. 返回成功                                 │
│                                              │
└─────────────────────────────────────────────┘
```

---

## 五、并发安全设计

### 5.1 问题场景

```
┌─────────────────────────────────────────────┐
│              并发问题场景                    │
├─────────────────────────────────────────────┤
│                                              │
│  用户A 发布了一个挂单（苹果×5 换 橙子×5）   │
│                                              │
│  10:00:00.001  用户B 点击"接受"             │
│  10:00:00.002  用户C 点击"接受"             │
│                                              │
│  如果不处理：                                │
│  - B 和 C 同时读取挂单状态：active          │
│  - B 和 C 都认为可以接受                    │
│  - B 和 C 都执行交换                        │
│  - 用户A 的 5 个苹果被复制成 10 个！        │
│                                              │
└─────────────────────────────────────────────┘
```

### 5.2 解决方案：行级锁

```
┌─────────────────────────────────────────────┐
│              使用行级锁后                    │
├─────────────────────────────────────────────┤
│                                              │
│  10:00:00.001  用户B 请求接受                │
│                → 锁定挂单记录                │
│                → 开始执行交换                │
│                                              │
│  10:00:00.002  用户C 请求接受                │
│                → 尝试锁定挂单                │
│                → 发现已被锁定               │
│                → 等待……                     │
│                                              │
│  10:00:00.050  用户B 完成交易                │
│                → 挂单状态变为 completed      │
│                → 释放锁                     │
│                                              │
│  10:00:00.051  用户C 获得锁                  │
│                → 读取挂单状态：completed    │
│                → 返回"挂单已失效"           │
│                                              │
│  完美！只有一个人能成功接受。               │
│                                              │
└─────────────────────────────────────────────┘
```

**实现要点**：
- 在接受交易时，查询挂单要使用行级锁
- 所有操作放在同一个数据库事务中
- 事务提交后自动释放锁

### 5.3 事务的重要性

```
┌─────────────────────────────────────────────┐
│              为什么需要事务？                │
├─────────────────────────────────────────────┤
│                                              │
│  接受交易涉及多个操作：                      │
│  1. 扣除接受者的物品                        │
│  2. 增加接受者的物品                        │
│  3. 增加发布者的物品                        │
│  4. 更新挂单状态                            │
│  5. 创建历史记录                            │
│                                              │
│  如果第3步失败了：                           │
│  - 接受者已经被扣了物品                     │
│  - 但发布者没收到物品                       │
│  - 数据不一致！                             │
│                                              │
│  使用事务后：                                │
│  - 要么全部成功                             │
│  - 要么全部回滚                             │
│  - 数据始终一致                             │
│                                              │
└─────────────────────────────────────────────┘
```

---

## 六、过期处理设计

### 6.1 两种处理方式

**方式一：定时任务清理**

```
┌─────────────────────────────────────────────┐
│              定时任务方式                    │
├─────────────────────────────────────────────┤
│                                              │
│  每隔一段时间（如每小时）执行：              │
│                                              │
│  1. 查询所有过期的活跃挂单                   │
│     - status = active                       │
│     - expires_at < 当前时间                 │
│                                              │
│  2. 遍历每个过期挂单                         │
│     - 退还物品到发布者库存                  │
│     - 更新状态为 expired                    │
│                                              │
│  优点：状态干净，expired 的就是过期的       │
│  缺点：需要配置定时任务                     │
│                                              │
└─────────────────────────────────────────────┘
```

**方式二：查询时过滤**

```
┌─────────────────────────────────────────────┐
│              查询时过滤方式                  │
├─────────────────────────────────────────────┤
│                                              │
│  查询可接受的挂单时，同时检查过期时间：      │
│                                              │
│  条件：                                      │
│  - status = active                          │
│  - expires_at > 当前时间                    │
│                                              │
│  优点：简单，不需要定时任务                  │
│  缺点：过期挂单的物品不会自动退回           │
│                                              │
│  解决方案：                                  │
│  - 用户打开"我的挂单"时检查并退还          │
│  - 或者用户下次发布时自动处理旧挂单         │
│                                              │
└─────────────────────────────────────────────┘
```

**建议**：根据项目规模选择
- 小项目：方式二（简单）
- 大项目：方式一（更规范）

---

## 七、权限与安全设计

### 7.1 基本权限规则

| 操作 | 权限要求 |
|------|---------|
| 创建挂单 | 已登录用户 |
| 查看所有挂单 | 已登录用户 |
| 接受挂单 | 已登录用户，且不是自己的挂单 |
| 取消挂单 | 只能取消自己的挂单 |
| 查看交易历史 | 只能看自己参与的交易 |
| 评价交易 | 只能评价自己参与的交易 |

### 7.2 数据访问控制

```
┌─────────────────────────────────────────────┐
│              行级安全策略                    │
├─────────────────────────────────────────────┤
│                                              │
│  trade_offers 表：                           │
│  - 所有人可以查看 active 状态的挂单         │
│  - 只有发布者可以看到自己的所有挂单         │
│  - 只有发布者可以取消自己的挂单             │
│                                              │
│  trade_history 表：                          │
│  - 只能看到自己是 seller 或 buyer 的记录    │
│  - 只能更新自己角色对应的评分字段           │
│                                              │
└─────────────────────────────────────────────┘
```

### 7.3 防作弊检查

| 检查项 | 说明 |
|--------|------|
| 物品数量验证 | 发布前验证库存，接受前验证库存 |
| 重复提交防护 | 使用行级锁防止并发 |
| 自交易防护 | 不能接受自己的挂单 |
| 状态验证 | 接受前检查状态和过期时间 |

---

## 八、服务层设计

### 8.1 TradeManager 的职责

```
┌─────────────────────────────────────────────┐
│              TradeManager 职责               │
├─────────────────────────────────────────────┤
│                                              │
│  1. 对接数据库                               │
│     - 调用后端函数                          │
│     - 处理返回结果                          │
│     - 错误处理和提示                        │
│                                              │
│  2. 管理本地状态                             │
│     - 我的挂单列表                          │
│     - 可接受的挂单列表                      │
│     - 交易历史列表                          │
│     - 加载状态（是否正在加载）              │
│                                              │
│  3. 通知界面更新                             │
│     - 数据变化时通知UI刷新                  │
│                                              │
│  4. 协调其他模块                             │
│     - 交易成功后刷新库存/背包               │
│                                              │
└─────────────────────────────────────────────┘
```

### 8.2 提供的方法

| 方法 | 功能 | 调用时机 |
|------|------|---------|
| createTradeOffer() | 创建挂单 | 用户点击"发布" |
| acceptTradeOffer() | 接受交易 | 用户点击"接受" |
| cancelTradeOffer() | 取消挂单 | 用户点击"取消" |
| loadMyOffers() | 加载我的挂单 | 打开"我的挂单"页面 |
| loadAvailableOffers() | 加载可接受的挂单 | 打开"交易市场"页面 |
| loadHistory() | 加载交易历史 | 打开"交易历史"页面 |
| rateTrade() | 评价交易 | 用户提交评价 |

---

