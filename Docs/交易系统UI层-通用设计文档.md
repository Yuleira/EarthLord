# 交易系统 UI 层 - 通用设计文档

---

## 一、前提条件

本文档假设你已经完成了交易系统的数据层，包括：
- 数据库表（trade_offers、trade_history）
- 后端函数（创建/接受/取消挂单、查询）
- 服务层（TradeManager）

现在需要实现用户界面，让用户能够使用交易功能。

---

## 二、页面结构概览

交易系统需要以下核心页面：

```
┌─────────────────────────────────────────────┐
│              交易系统页面结构                │
├─────────────────────────────────────────────┤
│                                              │
│  1. 发布挂单页面                             │
│     └─ 让用户创建新的交易请求               │
│                                              │
│  2. 我的挂单页面                             │
│     └─ 查看和管理自己发布的挂单             │
│                                              │
│  3. 交易市场页面                             │
│     └─ 浏览和接受其他用户的挂单             │
│                                              │
│  4. 交易历史页面                             │
│     └─ 查看已完成的交易，进行评价           │
│                                              │
│  5. 物品选择器（弹窗组件）                   │
│     └─ 在发布挂单时选择物品                 │
│                                              │
└─────────────────────────────────────────────┘
```

---

## 三、页面详细设计

### 3.1 发布挂单页面

**页面用途**：让用户填写"我想用什么换什么"。

**页面布局**：

```
┌─────────────────────────────────────────────┐
│              发布交易挂单                    │
├─────────────────────────────────────────────┤
│                                              │
│  ┌─────────────────────────────────────┐    │
│  │  我要出的物品                        │    │
│  │  ───────────────────────────────    │    │
│  │  （已选物品列表，可编辑/删除）       │    │
│  │                                     │    │
│  │  [+ 添加物品]                       │    │
│  └─────────────────────────────────────┘    │
│                                              │
│  ┌─────────────────────────────────────┐    │
│  │  我想要的物品                        │    │
│  │  ───────────────────────────────    │    │
│  │  （已选物品列表，可编辑/删除）       │    │
│  │                                     │    │
│  │  [+ 添加物品]                       │    │
│  └─────────────────────────────────────┘    │
│                                              │
│  有效期：[ 选择器：1/6/12/24/48/72小时 ]    │
│                                              │
│  留言（可选）：[ 输入框 ]                    │
│                                              │
│  [ 发布挂单 ]  ← 两边都有物品时才可点击     │
│                                              │
└─────────────────────────────────────────────┘
```

**交互逻辑**：

| 操作 | 响应 |
|------|------|
| 点击"添加物品" | 弹出物品选择器 |
| 选择物品后 | 物品出现在列表中，显示图标+名称+数量 |
| 点击已选物品 | 可以修改数量或删除 |
| 两边都有物品 | "发布挂单"按钮变为可点击 |
| 点击"发布挂单" | 显示加载状态 → 调用接口 → 成功提示 → 跳转到我的挂单 |
| 发布失败 | 显示错误原因（如"物品不足"） |

**数据要求**：
- "我要出的物品"：只能从用户库存中选择
- "我想要的物品"：可以选择系统中任意物品

---

### 3.2 我的挂单页面

**页面用途**：查看和管理自己发布的所有挂单。

**页面布局**：

```
┌─────────────────────────────────────────────┐
│              我的交易挂单                    │
├─────────────────────────────────────────────┤
│                                              │
│  [ 发布新挂单 ]                              │
│                                              │
│  ─────────────────────────────────────────   │
│                                              │
│  ┌─────────────────────────────────────┐    │
│  │  [状态标签]              剩余时间    │    │
│  │  ───────────────────────────────    │    │
│  │  我出：物品图标+名称+数量            │    │
│  │  我要：物品图标+名称+数量            │    │
│  │  ───────────────────────────────    │    │
│  │  （如果已完成）被 @用户名 接受       │    │
│  │  （如果等待中）[ 取消挂单 ]          │    │
│  └─────────────────────────────────────┘    │
│                                              │
│  ┌─────────────────────────────────────┐    │
│  │  （更多挂单卡片...）                 │    │
│  └─────────────────────────────────────┘    │
│                                              │
│  （空状态：还没有发布过挂单）                │
│                                              │
└─────────────────────────────────────────────┘
```

**状态标签样式**：

| 状态 | 标签文字 | 颜色建议 |
|------|---------|---------|
| active | 等待中 | 蓝色 |
| completed | 已完成 | 绿色 |
| cancelled | 已取消 | 灰色 |
| expired | 已过期 | 橙色 |

**交互逻辑**：

| 操作 | 响应 |
|------|------|
| 进入页面 | 加载我的挂单列表 |
| 下拉刷新 | 重新加载列表 |
| 点击"取消挂单" | 弹出确认框 → 确认后调用接口 → 刷新列表 |
| 点击挂单卡片 | 可选：展开详情或跳转详情页 |

**显示规则**：
- 按时间倒序排列（最新的在前）
- 等待中的挂单显示剩余时间倒计时
- 已完成的挂单显示接受者信息

---

### 3.3 交易市场页面

**页面用途**：浏览其他用户的挂单，找到想要的进行交易。

**页面布局**：

```
┌─────────────────────────────────────────────┐
│              交易市场                        │
├─────────────────────────────────────────────┤
│                                              │
│  （可选：搜索/筛选栏）                        │
│                                              │
│  ─────────────────────────────────────────   │
│                                              │
│  ┌─────────────────────────────────────┐    │
│  │  👤 发布者用户名          剩余时间   │    │
│  │  ───────────────────────────────    │    │
│  │  他出：物品图标+名称+数量            │    │
│  │  他要：物品图标+名称+数量            │    │
│  │  ───────────────────────────────    │    │
│  │  （可选：留言预览）                  │    │
│  │                   [ 查看详情 ]       │    │
│  └─────────────────────────────────────┘    │
│                                              │
│  ┌─────────────────────────────────────┐    │
│  │  （更多挂单卡片...）                 │    │
│  └─────────────────────────────────────┘    │
│                                              │
│  （空状态：暂无可用的交易挂单）              │
│                                              │
└─────────────────────────────────────────────┘
```

**点击"查看详情"后的详情页**：

```
┌─────────────────────────────────────────────┐
│              挂单详情                        │
├─────────────────────────────────────────────┤
│                                              │
│  👤 发布者用户名                             │
│  发布于 X小时前 · 剩余 X小时                │
│                                              │
│  ─────────────────────────────────────────   │
│                                              │
│  他提供：                                    │
│  ┌────────┐ ┌────────┐                      │
│  │ 物品1  │ │ 物品2  │ ...                 │
│  │  ×数量 │ │  ×数量 │                      │
│  └────────┘ └────────┘                      │
│                                              │
│  他想要：                                    │
│  ┌────────┐                                 │
│  │ 物品   │                                 │
│  │  ×数量 │                                 │
│  └────────┘                                 │
│                                              │
│  留言："发布者的留言内容"                    │
│                                              │
│  ─────────────────────────────────────────   │
│                                              │
│  你的库存：物品名 ×数量  ✅足够 / ❌不足     │
│                                              │
│  [ 接受交易 ]  ← 物品足够时可点击            │
│                                              │
└─────────────────────────────────────────────┘
```

**交互逻辑**：

| 操作 | 响应 |
|------|------|
| 进入页面 | 加载可用挂单列表（排除自己的） |
| 下拉刷新 | 重新加载列表 |
| 点击挂单卡片 | 进入详情页 |
| 详情页检查库存 | 自动检查用户是否有足够物品 |
| 物品不足 | "接受交易"按钮禁用，显示缺少什么 |
| 点击"接受交易" | 弹出确认框 |
| 确认交易 | 调用接口 → 成功提示 → 刷新库存 → 返回列表 |

**确认框内容**：

```
┌─────────────────────────────────────────────┐
│              确认交易                        │
├─────────────────────────────────────────────┤
│                                              │
│  你将付出：                                  │
│  · 物品A ×数量                              │
│                                              │
│  你将获得：                                  │
│  · 物品B ×数量                              │
│                                              │
│        [ 取消 ]    [ 确认交易 ]              │
│                                              │
└─────────────────────────────────────────────┘
```

---

### 3.4 交易历史页面

**页面用途**：查看已完成的交易记录，进行评价。

**页面布局**：

```
┌─────────────────────────────────────────────┐
│              交易历史                        │
├─────────────────────────────────────────────┤
│                                              │
│  ┌─────────────────────────────────────┐    │
│  │  与 @用户名 的交易        完成时间   │    │
│  │  ───────────────────────────────    │    │
│  │  你给出：物品+数量                   │    │
│  │  你获得：物品+数量                   │    │
│  │  ───────────────────────────────    │    │
│  │  你的评价：⭐⭐⭐⭐⭐ "评语"         │    │
│  │  对方评价：⭐⭐⭐⭐☆ "评语"         │    │
│  │  （或：未评价 [ 去评价 ]）           │    │
│  └─────────────────────────────────────┘    │
│                                              │
│  ┌─────────────────────────────────────┐    │
│  │  （更多交易记录...）                 │    │
│  └─────────────────────────────────────┘    │
│                                              │
│  （空状态：还没有交易记录）                  │
│                                              │
└─────────────────────────────────────────────┘
```

**点击"去评价"后的评价弹窗**：

```
┌─────────────────────────────────────────────┐
│              评价交易                        │
├─────────────────────────────────────────────┤
│                                              │
│  与 @用户名 的交易                           │
│                                              │
│  请给这次交易打分：                          │
│                                              │
│       ☆    ☆    ☆    ☆    ☆               │
│       1    2    3    4    5                 │
│                                              │
│  评语（可选）：                               │
│  ┌─────────────────────────────────────┐    │
│  │                                     │    │
│  └─────────────────────────────────────┘    │
│                                              │
│        [ 取消 ]    [ 提交评价 ]              │
│                                              │
└─────────────────────────────────────────────┘
```

**交互逻辑**：

| 操作 | 响应 |
|------|------|
| 进入页面 | 加载交易历史列表 |
| 点击"去评价" | 弹出评价弹窗 |
| 选择星星 | 高亮选中的星星及之前的 |
| 提交评价 | 调用接口 → 成功提示 → 刷新列表 |

---

### 3.5 物品选择器（弹窗组件）

**组件用途**：在发布挂单时，用于选择物品和数量。

**组件布局**：

```
┌─────────────────────────────────────────────┐
│              选择物品                        │
├─────────────────────────────────────────────┤
│                                              │
│  🔍 [ 搜索物品... ]                          │
│                                              │
│  ─────────────────────────────────────────   │
│                                              │
│  分类名称                                    │
│  ┌────────┐ ┌────────┐ ┌────────┐          │
│  │  图标  │ │  图标  │ │  图标  │          │
│  │ 物品名 │ │ 物品名 │ │ 物品名 │          │
│  │  ×数量 │ │  ×数量 │ │  ×数量 │          │
│  └────────┘ └────────┘ └────────┘          │
│                                              │
│  另一分类                                    │
│  ┌────────┐ ┌────────┐                      │
│  │  ...   │ │  ...   │                      │
│  └────────┘ └────────┘                      │
│                                              │
└─────────────────────────────────────────────┘
```

**点击物品后的数量选择**：

```
┌─────────────────────────────────────────────┐
│              选择数量                        │
├─────────────────────────────────────────────┤
│                                              │
│             物品图标                          │
│             物品名称                          │
│                                              │
│        （库存中有：X 个）                    │
│                                              │
│        [ - ]   数量   [ + ]                  │
│                                              │
│        [ 取消 ]    [ 确认添加 ]              │
│                                              │
└─────────────────────────────────────────────┘
```

**两种使用场景**：

| 场景 | 数据源 | 数量限制 |
|------|--------|---------|
| 选择"我要出的物品" | 用户库存 | 不能超过库存数量 |
| 选择"我想要的物品" | 全部物品列表 | 无限制（可输入任意数量） |

---

## 四、页面导航结构

```
┌─────────────────────────────────────────────┐
│              页面导航关系                    │
├─────────────────────────────────────────────┤
│                                              │
│   交易入口（Tab/按钮）                        │
│        │                                     │
│        ├──→ 我的挂单                         │
│        │       │                             │
│        │       ├──→ 发布新挂单               │
│        │       │       └──→ 物品选择器(弹窗) │
│        │       │                             │
│        │       └──→ 取消确认(弹窗)           │
│        │                                     │
│        ├──→ 交易市场                         │
│        │       │                             │
│        │       └──→ 挂单详情                 │
│        │               └──→ 接受确认(弹窗)   │
│        │                                     │
│        └──→ 交易历史                         │
│                │                             │
│                └──→ 评价弹窗                 │
│                                              │
└─────────────────────────────────────────────┘
```

**导航方式建议**：

| 页面类型 | 导航方式 |
|---------|---------|
| 主要页面（我的挂单/市场/历史） | Tab切换 或 顶部分段控件 |
| 详情页 | 全屏推入（Push） |
| 选择器/确认框/评价 | 底部弹窗（Sheet）或 对话框（Alert） |

---

## 五、状态管理

### 5.1 需要管理的状态

```
┌─────────────────────────────────────────────┐
│              UI 层需要的状态                 │
├─────────────────────────────────────────────┤
│                                              │
│  页面数据状态                                │
│  ├─ 我的挂单列表                            │
│  ├─ 可用挂单列表（市场）                    │
│  └─ 交易历史列表                            │
│                                              │
│  加载状态                                    │
│  ├─ 是否正在加载列表                        │
│  ├─ 是否正在提交（发布/接受/取消）          │
│  └─ 是否正在评价                            │
│                                              │
│  表单状态（发布页面）                        │
│  ├─ 已选的"我要出"物品列表                  │
│  ├─ 已选的"我想要"物品列表                  │
│  ├─ 选择的有效期                            │
│  └─ 留言内容                                │
│                                              │
│  弹窗状态                                    │
│  ├─ 是否显示物品选择器                      │
│  ├─ 是否显示确认框                          │
│  └─ 是否显示评价弹窗                        │
│                                              │
└─────────────────────────────────────────────┘
```

### 5.2 数据刷新时机

| 事件 | 需要刷新的数据 |
|------|---------------|
| 发布挂单成功 | 我的挂单列表、用户库存 |
| 接受交易成功 | 市场列表、用户库存、交易历史 |
| 取消挂单成功 | 我的挂单列表、用户库存 |
| 提交评价成功 | 交易历史列表 |
| 进入页面 | 对应页面的列表数据 |
| 下拉刷新 | 当前页面的列表数据 |

---

## 六、错误处理与提示

### 6.1 操作结果提示

| 操作 | 成功提示 | 失败提示 |
|------|---------|---------|
| 发布挂单 | "挂单发布成功！" | 显示具体错误（如"物品不足"） |
| 接受交易 | "交易成功！已获得 XXX" | 显示具体错误 |
| 取消挂单 | "挂单已取消，物品已退回" | 显示具体错误 |
| 提交评价 | "评价成功！" | "评价失败，请重试" |

### 6.2 边界情况处理

| 情况 | 处理方式 |
|------|---------|
| 列表为空 | 显示空状态插图和文字 |
| 网络错误 | 显示错误提示，提供重试按钮 |
| 物品不足 | 禁用按钮，显示缺少的物品和数量 |
| 挂单已失效 | 显示"该挂单已被接受或取消"，返回列表 |
| 正在加载 | 显示加载指示器，禁用重复操作 |

---

## 七、与数据层的对接

### 7.1 调用 TradeManager 的方法

| UI 操作 | 调用的方法 |
|---------|-----------|
| 发布挂单 | TradeManager.createTradeOffer() |
| 接受交易 | TradeManager.acceptTradeOffer() |
| 取消挂单 | TradeManager.cancelTradeOffer() |
| 加载我的挂单 | TradeManager.loadMyOffers() |
| 加载市场挂单 | TradeManager.loadAvailableOffers() |
| 加载交易历史 | TradeManager.loadHistory() |
| 提交评价 | TradeManager.rateTrade() |

### 7.2 交易成功后的联动

```
接受交易成功后，需要：

1. 显示成功提示（告诉用户获得了什么）
2. 刷新用户库存（物品数量已变化）
3. 刷新市场列表（刚接受的挂单要消失）
4. 可选：刷新交易历史（新增一条记录）
```

---

